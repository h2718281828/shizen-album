<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>自然のアルバム</title>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&family=Noto+Serif+JP&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <style>
    body {
      background-image: url('./images/background.webp');
      background-size: cover;
      background-position: center;
      font-family: 'M PLUS Rounded 1c', 'Noto Serif JP', serif;
      margin: 0;
      padding: 0;
    }

    h1 {
      font-size: 3rem;
      font-weight: 700;
      background: linear-gradient(90deg, #4caf50, #81c784, #a5d6a7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      text-align: center;
      margin: 20px 0 10px;
    }

    .upload-section {
      text-align: center;
      margin-bottom: 20px;
    }

    input[type="file"], input[type="text"], button {
      margin: 5px;
      padding: 8px;
      font-size: 16px;
      border-radius: 5px;
      box-sizing: border-box;
    }

    button {
      cursor: pointer;
    }

    .sort-buttons {
      text-align: center;
      margin-bottom: 10px;
    }

    .gallery {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      padding: 10px;
      box-sizing: border-box;
    }

    .photo-card {
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 90vw;
      max-width: 300px;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .photo-card img {
      width: 100%;
      border-radius: 8px;
      object-fit: cover;
    }

    .comment, .meta {
      margin-top: 6px;
      font-size: 14px;
      color: #555;
    }

    .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #ff4d4d;
      border: none;
      border-radius: 4px;
      color: white;
      padding: 3px 6px;
      font-size: 12px;
    }

    #map {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 350px;
      height: 400px;
      border: 2px solid #2e8b57;
      border-radius: 10px;
      z-index: 1000;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    @media (max-width: 900px) {
      #map {
        position: static;
        width: 90%;
        height: 300px;
        margin: 20px auto;
      }
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 2rem;
      }

      .photo-card {
        width: 95%;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.6rem;
      }

      .sort-buttons button {
        font-size: 13px;
        padding: 6px 12px;
      }
    }
  </style>
</head>
<body>
  <h1>自然のアルバム</h1>
  <div class="upload-section">
    <input type="file" id="photoInput" accept="image/*" />
    <input type="text" id="photoComment" placeholder="コメントを入力" />
    <button onclick="addPhoto()">投稿</button>
  </div>
  <div class="sort-buttons">
    <button onclick="sortPosts('desc')">新しい順</button>
    <button onclick="sortPosts('asc')">古い順</button>
  </div>
  <div class="gallery" id="gallery"></div>
  <div id="map"></div>
  <script>
    const gallery = document.getElementById('gallery');
    let posts = JSON.parse(localStorage.getItem('photoPosts')) || [];

    const map = L.map('map').setView([39.7036, 141.1527], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    let markersGroup = L.layerGroup().addTo(map);

    function updateMapMarkers() {
      markersGroup.clearLayers();
      posts.forEach((post, i) => {
        if(post.lat && post.lon){
          const marker = L.marker([post.lat, post.lon]).addTo(markersGroup);
          const popupHtml = `
            <div style="max-width: 250px;">
              <img src="${post.image}" alt="写真" style="width: 100%; border-radius: 5px;" />
              <p><strong>コメント:</strong> ${post.comment || 'なし'}</p>
              <p style="font-size:12px; color:#666;">撮影日時: ${post.takenDate}</p>
              <p style="font-size:12px; color:#666;">投稿日時: ${post.date}</p>
              <button onclick="deletePost(${i})" style="background:#ff4d4d; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">削除</button>
            </div>
          `;
          marker.bindPopup(popupHtml);
        }
      });
    }

    function renderPosts() {
      gallery.innerHTML = '';
      posts.forEach((post, index) => {
        const card = document.createElement('div');
        card.className = 'photo-card';
        card.innerHTML = `
          <button class="delete-btn" onclick="deletePost(${index})">✕</button>
          <img src="${post.image}" alt="自然の写真" />
          <div class="comment">${post.comment || ''}</div>
          <div class="meta">投稿日時: ${post.date}</div>
          <div class="meta">撮影日時: ${post.takenDate}</div>
          <div class="meta">${post.location}</div>
        `;
        gallery.appendChild(card);
      });
      updateMapMarkers();
    }

    function deletePost(index) {
      if(confirm('この投稿を削除してもいい？')){
        posts.splice(index, 1);
        localStorage.setItem('photoPosts', JSON.stringify(posts));
        renderPosts();
      }
    }

    function sortPosts(order) {
      posts.sort((a, b) => {
        function parseDate(dateStr){
          if(!dateStr || dateStr === '不明') return new Date(0);
          const fixedStr = dateStr.replace(/^(\d{4}):(\d{2}):(\d{2})/, '$1-$2-$3');
          return new Date(fixedStr);
        }
        const dateA = parseDate(a.takenDate) || new Date(a.date);
        const dateB = parseDate(b.takenDate) || new Date(b.date);
        return order === 'asc' ? dateA - dateB : dateB - dateA;
      });
      renderPosts();
    }

    function getGPSDecimal(coord, ref) {
      if (!coord || !ref) return null;
      const d = coord[0].numerator / coord[0].denominator;
      const m = coord[1].numerator / coord[1].denominator;
      const s = coord[2].numerator / coord[2].denominator;
      let decimal = d + m / 60 + s / 3600;
      if (ref === "S" || ref === "W") {
        decimal = -decimal;
      }
      return decimal;
    }

    function addPhoto() {
      const fileInput = document.getElementById('photoInput');
      const commentInput = document.getElementById('photoComment');
      const file = fileInput.files[0];
      const comment = commentInput.value;

      if (!file) {
        alert("画像を選んでね！");
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        EXIF.getData(file, function () {
          const now = new Date();
          const dateStr = now.toLocaleString('ja-JP', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
          });

          const takenDate = EXIF.getTag(this, "DateTimeOriginal") || "不明";
          const lat = getGPSDecimal(EXIF.getTag(this, "GPSLatitude"), EXIF.getTag(this, "GPSLatitudeRef"));
          const lon = getGPSDecimal(EXIF.getTag(this, "GPSLongitude"), EXIF.getTag(this, "GPSLongitudeRef"));
          const location = (lat && lon) ? `\u{1F4CD}緯度:${lat.toFixed(6)}, 経度:${lon.toFixed(6)}` : "\u{1F4CD}位置情報なし";

          const post = {
            image: e.target.result,
            comment: comment,
            date: dateStr,
            takenDate: takenDate,
            location: location,
            lat: lat,
            lon: lon
          };

          if (posts.length >= 5) posts.shift();
          posts.push(post);
          localStorage.setItem('photoPosts', JSON.stringify(posts));
          renderPosts();

          fileInput.value = '';
          commentInput.value = '';
        });
      };
      reader.readAsDataURL(file);
    }

    renderPosts();
  </script>
</body>
</html>
