<!DOCTYPE html>
<html lang="ja">
<head>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&family=Noto+Serif+JP&display=swap" rel="stylesheet">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è‡ªç„¶ã®ã‚¢ãƒ«ãƒãƒ </title>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- EXIF -->
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

  <style>
    body {
      background-image: url('./images/background.webp');
      background-size: cover;
      background-position: center;
    }


    h1 {
      font-family: 'M PLUS Rounded 1c', 'Noto Serif JP', serif;
      font-size: 3rem;
      font-weight: 700;
      background: linear-gradient(90deg, #4caf50, #81c784, #a5d6a7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      text-align: center;
      margin-bottom: 10px;
    }

    .upload-section {
      text-align: center;
      margin-bottom: 20px;
    }
    input[type="file"], input[type="text"] {
      margin: 5px;
    }
    button {
      cursor: pointer;
    }
    .sort-buttons {
      text-align: center;
      margin-bottom: 10px;
    }
    .gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }
    .photo-card {
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 250px;
      position: relative;
    }
    .photo-card img {
      width: 100%;
      border-radius: 8px;
    }
    .comment, .meta {
      margin-top: 6px;
      font-size: 14px;
      color: #555;
    }
    .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #ff4d4d;
      border: none;
      border-radius: 4px;
      color: white;
      padding: 3px 6px;
      font-size: 12px;
    }

    /* å³ä¸Šã«åœ°å›³å›ºå®šè¡¨ç¤º */
    #map {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 350px;
      height: 400px;
      border: 2px solid #2e8b57;
      border-radius: 10px;
      z-index: 1000;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>

  <h1>è‡ªç„¶ã®ã‚¢ãƒ«ãƒãƒ </h1>

  <div class="upload-section">
    <input type="file" id="photoInput" accept="image/*" />
    <input type="text" id="photoComment" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›" />
    <button onclick="addPhoto()">æŠ•ç¨¿</button>
  </div>

  <div class="sort-buttons">
    <button onclick="sortPosts('desc')">æ–°ã—ã„é †</button>
    <button onclick="sortPosts('asc')">å¤ã„é †</button>
  </div>

  <div class="gallery" id="gallery"></div>

  <!-- å³ä¸Šå›ºå®šåœ°å›³ -->
  <div id="map"></div>

<script>
  const gallery = document.getElementById('gallery');
  let posts = JSON.parse(localStorage.getItem('photoPosts')) || [];

  // Leafletåœ°å›³åˆæœŸåŒ–
  const map = L.map('map').setView([39.7036, 141.1527], 6); // å²©æ‰‹çœŒä¸­å¿ƒã‚ãŸã‚Š

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // ãƒãƒ¼ã‚«ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†ç”¨
  let markersGroup = L.layerGroup().addTo(map);

  // æŠ•ç¨¿ã‚’åœ°å›³ã«åæ˜ 
  function updateMapMarkers() {
    markersGroup.clearLayers(); // å¤ã„ãƒãƒ¼ã‚«ãƒ¼å…¨éƒ¨æ¶ˆã™
    posts.forEach((post, i) => {
      if(post.lat && post.lon){
        const marker = L.marker([post.lat, post.lon]).addTo(markersGroup);
        const popupHtml = `
          <div style="max-width: 250px;">
            <img src="${post.image}" alt="å†™çœŸ" style="width: 100%; border-radius: 5px;" />
            <p style="margin:5px 0;"><strong>ã‚³ãƒ¡ãƒ³ãƒˆ:</strong> ${post.comment || 'ãªã—'}</p>
            <p style="margin:2px 0; font-size:12px; color:#666;">æ’®å½±æ—¥æ™‚: ${post.takenDate}</p>
            <p style="margin:2px 0; font-size:12px; color:#666;">æŠ•ç¨¿æ—¥æ™‚: ${post.date}</p>
            <button onclick="deletePost(${i})" style="background:#ff4d4d; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">å‰Šé™¤</button>
          </div>
        `;
        marker.bindPopup(popupHtml);
      }
    });
  }

  // æŠ•ç¨¿è¡¨ç¤º
  function renderPosts() {
    gallery.innerHTML = '';
    posts.forEach((post, index) => {
      const card = document.createElement('div');
      card.className = 'photo-card';
      card.innerHTML = `
        <button class="delete-btn" onclick="deletePost(${index})">âœ•</button>
        <img src="${post.image}" alt="è‡ªç„¶ã®å†™çœŸ" />
        <div class="comment">${post.comment || ''}</div>
        <div class="meta">æŠ•ç¨¿æ—¥æ™‚: ${post.date}</div>
        <div class="meta">æ’®å½±æ—¥æ™‚: ${post.takenDate}</div>
        <div class="meta">${post.location}</div>
      `;
      gallery.appendChild(card);
    });
    updateMapMarkers();
  }

  // å‰Šé™¤å‡¦ç†
  function deletePost(index) {
    if(confirm('ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã„ã„ï¼Ÿ')){
      posts.splice(index,1);
      localStorage.setItem('photoPosts', JSON.stringify(posts));
      renderPosts();
    }
  }

  // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
  function sortPosts(order) {
    posts.sort((a, b) => {
      // æ’®å½±æ—¥æ™‚ã®"YYYY:MM:DD hh:mm:ss"å½¢å¼ã‹ä¸æ˜ã‹åˆ¤å®šã—ã¦ãƒ‘ãƒ¼ã‚¹ã€‚æ’®å½±æ—¥æ™‚ä¸æ˜ãªã‚‰æŠ•ç¨¿æ—¥æ™‚ã§æ¯”è¼ƒ
      function parseDate(dateStr){
        if(!dateStr || dateStr === 'ä¸æ˜') return new Date(0); //ã‹ãªã‚Šæ˜”ã«ã™ã‚‹
        // Exifã®æ’®å½±æ—¥æ™‚ã¯ "YYYY:MM:DD hh:mm:ss" å½¢å¼
        const fixedStr = dateStr.replace(/^(\d{4}):(\d{2}):(\d{2})/, '$1-$2-$3');
        return new Date(fixedStr);
      }

      const dateA = parseDate(a.takenDate) || new Date(a.date);
      const dateB = parseDate(b.takenDate) || new Date(b.date);

      return order === 'asc' ? dateA - dateB : dateB - dateA;
    });
    renderPosts();
  }

  // GPSåº§æ¨™ã‚’10é€²æ•°ã«å¤‰æ›ã™ã‚‹é–¢æ•°
  function getGPSDecimal(coord, ref) {
    if (!coord || !ref) return null;
    const d = coord[0].numerator / coord[0].denominator;
    const m = coord[1].numerator / coord[1].denominator;
    const s = coord[2].numerator / coord[2].denominator;
    let decimal = d + m / 60 + s / 3600;
    if (ref === "S" || ref === "W") {
      decimal = -decimal;
    }
    return decimal;
  }

  // æŠ•ç¨¿è¿½åŠ 
  function addPhoto() {
    const fileInput = document.getElementById('photoInput');
    const commentInput = document.getElementById('photoComment');

    const file = fileInput.files[0];
    const comment = commentInput.value;

    if (!file) {
      alert("ç”»åƒã‚’é¸ã‚“ã§ã­ï¼");
      return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
      EXIF.getData(file, function () {
        const now = new Date();
        const dateStr = now.toLocaleString('ja-JP', {
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit'
        });

        const takenDate = EXIF.getTag(this, "DateTimeOriginal") || "ä¸æ˜";
        const lat = getGPSDecimal(EXIF.getTag(this, "GPSLatitude"), EXIF.getTag(this, "GPSLatitudeRef"));
        const lon = getGPSDecimal(EXIF.getTag(this, "GPSLongitude"), EXIF.getTag(this, "GPSLongitudeRef"));
        const location = (lat && lon) ? `ğŸ“ç·¯åº¦:${lat.toFixed(6)}, çµŒåº¦:${lon.toFixed(6)}` : "ğŸ“ä½ç½®æƒ…å ±ãªã—";

        const post = {
          image: e.target.result,
          comment: comment,
          date: dateStr,
          takenDate: takenDate,
          location: location,
          lat: lat,
          lon: lon
        };

        // å¤ã„æŠ•ç¨¿è‡ªå‹•å‰Šé™¤(5ä»¶ã¾ã§ä¿æŒ)
        if (posts.length >= 5) {
          posts.shift();
        }

        posts.push(post);
        localStorage.setItem('photoPosts', JSON.stringify(posts));

        renderPosts();

        fileInput.value = '';
        commentInput.value = '';
      });
    };

    reader.readAsDataURL(file);
  }

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æç”»
  renderPosts();
</script>

</body>
</html>
